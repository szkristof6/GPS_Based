const users=require("../../db/users"),JWT_sign=require("../jwt"),captcha=require("../captcha");async function facebookLogin(e,s){try{"connected"!=e.body.status&&s.send({message:"Not connected!"});if(!await captcha(e))return void s.send({status:"error",message:"Captcha failed!"});const t=["email","name","picture"].join(","),a=`https://graph.facebook.com/me?fields=${t}&access_token=${e.body.authResponse.accessToken}`,o=await fetch(a,{method:"get"}).then((e=>e.json())),n=await users.findOne({email:o.email});if(n){if("facebook"!=n.login_method)return void s.send({status:"error",message:"Email method was used for signin!"});{const e=JWT_sign(n);return void s.send({status:"success",token:e})}}const i=await users.insert({name:o.name,email:o.email,login_method:"facebook",image:o.picture.data.url,permission:0}),c=JWT_sign(i);return void s.send({status:"success",token:c})}catch(e){return e.message.startsWith("E11000")&&(e.message="This account already exists!"),void s.send(e)}}module.exports=facebookLogin;