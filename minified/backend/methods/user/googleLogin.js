const{OAuth2Client:OAuth2Client}=require("google-auth-library");require("dotenv").config();const users=require("../../db/users"),JWT_sign=require("../jwt"),captcha=require("../captcha");async function googleLogin(e,s){if(!await captcha(e))return void s.send({status:"error",message:"Captcha failed!"});const t=new OAuth2Client(process.env.GOOGLE_CLIENT_ID);try{const i=(await t.verifyIdToken({idToken:e.body.credential,audience:process.env.GOOGLE_CLIENT_ID})).getPayload(),n=await users.findOne({email:i.email});if(n){if("google"!=n.login_method)return void s.send({status:"error",message:"Email method was used for signin!"});{const e=JWT_sign(n);return void s.send({status:"success",token:e})}}const a=await users.insert({name:i.name,email:i.email,login_method:"google",image:i.picture,permission:0}),o=JWT_sign(a);return void s.send({status:"success",token:o})}catch(e){return e.message.startsWith("E11000")&&(e.message="This account already exists!"),void s.send(e)}}module.exports=googleLogin;