const bcrypt=require("bcrypt");require("dotenv").config();const{registerSchema:registerSchema}=require("../../schemas/user"),users=require("../../db/users"),JWT_sign=require("../jwt"),captcha=require("../captcha");async function registerUser(e,s){try{if(!await captcha(e))return void s.send({status:"error",message:"Captcha failed!"});if(await registerSchema.validate(e.body),e.body.password!==e.body.passwordre)return void s.send({status:"error",message:"The passwords are not matching!"});const r=5,a=await bcrypt.genSalt(r).then((s=>bcrypt.hash(e.body.password,s))),t=`${e.body.firstname} ${e.body.lastname}`;await users.insert({name:t,password:a,email:e.body.email,date:e.body.date,login_method:"email",image:`https://eu.ui-avatars.com/api/?name=${t}&size=250`,permission:0});return void s.send({status:"success"})}catch(e){return e.message.startsWith("E11000")&&(e.message="This account already exists!"),void s.send(e)}}module.exports=registerUser;